# version-script

JavaScript script to increase the SemVer of a node application based on Merge Request labels


# Overview

## Process
In order to increase the SemVer of a package we need to go through the following steps:

+ Find the Merge Request associated to the commit
+ Retrieve which part of the version to increase from the Merge Request labels (or default to PATCH)
+ Perform the version increase and push the changes back to master

## Project organisation
The code is divided into two files:
+ index.js  
  This will execute all the steps discussed above and in case of an error it will terminate the process and log the error message in the console.
+ src/script.js  
  This file contains the functions responsible for all the different parts of the script.

## Code structure
The code is divided in four functions which roughly mirror the process' steps:

+ Find Merge Request
  + getMergeRequestUrl
  + getMergeRequest
+ Retrieve which part to update
  + getMergeRequest
  + getUpdateType
+ Perform the version increase
  + increaseVersion

### getMergeRequestUrl

|Inputs|Outputs|
|------|-------|
|None  |Promise|

#### Output scenarios
| Promise | Value | Value type | Scenario |
|---------|-------|------------|----------|
| resolve | GitLab API url | string | Regular expression matched |
| reject  | Failed to find merge request in commit message | string | commit message is null or empty |
| reject  | Failed to find merge request in commit message | string | the regular expression test returned false on the commit message |


This function first get the commit message from one of the GitLab CI system variable called *CI_COMMIT_MESSAGE*. Then it applies this regular expression `/merge request! .+(\d+)/` to find the merge request id.  
If the regular expression matches the function resolves by constructing a URL to retrieve the Merge Request via GitLab REsT API.


### getMergeRequest

|Inputs|Outputs|
|------|-------|
|string|Promise|

#### Output scenarios
| Promise | Value | Value type | Scenario |
|---------|-------|------------|----------|
| resolve | Merge request | JSON Object | Successfully called GitLab API |
| reject  | Failed to connect to GitLab: | string | GitLab returned a statusCode outside the 200-299 bracket |
| reject  | Error message | Error object | The stream object triggered an error event |


This function retrieves the merge request from GitLab REsT API based on the URL returned from the getMergerequestUrl function.


### getUpdateType

|Inputs|Outputs|
|------|-------|
|JSON Object|Promise|

#### Output scenarios
| Promise | Value | Value type | Scenario |
|---------|-------|------------|----------|
| resolve | SemVer section | string | Found a label match one of the SemVer sections |
| reject  | patch | string | Defaults to patch if it fails to find a valid value |

This function goes through all the labels of the merge request looking for major, minor or patch and returns it if it finds it. Otherwise, returns patch as default value.


### increaseVersion

|Inputs|Outputs|
|------|-------|
|string|Promise|

#### Output scenarios
| Promise | Value | Value type | Scenario |
|---------|-------|------------|----------|
| resolve | Done  | string | Managed to increase the version and push the changes back to the repo |
| reject  | Failed to push with error: | string | Failed to push the changes back to GitLab |
| reject  | Failed to change version | string | An error occurred at some point during this process |
