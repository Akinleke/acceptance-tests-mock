image: node:8

stages:
  - test
  - version
  - publish

before_script:
  - apt-get update -qq
  - npm ci

unit-test:
  stage: test
  script:
    - npm test
  coverage: /All files \s*\||s*([\d\.]+)/

version:
  stage: version
  only:
    - master
  except:
    - tags
    - $CI_COMMIT_MESSAGE =~ /^\d+\.\d+\.\d+a$/
  before_script:
    - git config user.email $GITLAB_USER_EMAIL
    - git config user.name $GITLAB_USER_NAME
    - mkdir -p ~/.ssh && chmod 700 ~/.ssh
    - ssh-keyscan gitlab.tools.digital.coveahosted.co.uk >> ~/.ssh/known_hosts && chmod 644 ~/.ssh/known_hosts
    - eval $(ssh-agent -s)
    - ssh-add <(echo "$GITLAB_CI_PRIVATE_KEY")
  script:
    - ./index.js

nexus-publish:
  stage: publish
  only: 
    - /^v\d+\.\d+\.\d+$/
  script:
    - echo '//nexus.tools.digital.coveahosted.co.uk/repository/npm/:_authToken=${NEXUS_NPM_PUSH_TOKEN}' > .npmrc
    - npm publish --access restricted --verbose
